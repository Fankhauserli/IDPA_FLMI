<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IDPA FLMI — Attention</title>
    <meta name="description" content="Erklärung der Attention Mechanismus in LLMs" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/styles.css" />
</head>
<body class="antialiased bg-gray-50 text-gray-800">
    <header class="bg-white shadow">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
            <a href="/" class="text-indigo-600 hover:underline">← Zurück zur Übersicht</a>
            <h1 class="text-3xl font-bold mt-2">Attention</h1>
            <p class="text-gray-600 mt-1">Wie ein neuronales Netzwerk Kontext lernt</p>
        </div>
    </header>
    <main class="max-w-4xl mx-auto px-4 py-12">
        <div class="bg-white p-8 rounded-lg shadow space-y-8">

            <div>
                <p class="text-lg leading-relaxed">Im Einbettungsschritt haben wir den Input ins LLM in verschiedenen Token aufgetrennt und für jeden Token ein Vektor erhalten. Dies ist jedoch noch sehr linear, das Wort Bank wird immer als gleicher Vektor interpretiert. Die unterschiedliche Bedeutung des Wortes “Bank” können nicht widergespiegelt werden. Neben dem Finanzinstitut kann es auch eine Bank in einem Park sein. Damit die Bedeutung des Wortes definiert werden kann, muss der Kontext um “Bank” angeschaut werden. In der Attention können die anderen Tokens, welche auch eingebettet wurden, den Vektor für “Bank” beeinflussen. Somit kann innerhalb der Attention das Wort “Bank” beeinflusst werden, damit dies besser eine Parkbank repräsentiert. In diesem Abschnitt werden wir nur die Self-Attention genauer anschauen, die Cross-Attention lassen wir aus.</p>
                <div class="mt-6 bg-gray-100 p-6 rounded-lg">
                    <svg viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg" class="w-full">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:rgb(129,140,248);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:rgb(59,130,246);stop-opacity:1" />
                            </linearGradient>
                            <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgb(156, 163, 175)"></path>
                            </marker>
                        </defs>

                        <!-- Base "Bank" Vektor -->
                        <rect x="300" y="20" width="200" height="50" rx="10" fill="url(#grad1)"></rect>
                        <text x="400" y="55" font-family="monospace" font-size="20" fill="white" text-anchor="middle">Vektor für "Bank"</text>

                        <!-- Kontext: Geld -->
                        <circle cx="100" cy="150" r="40" fill="rgb(252, 211, 77)"></circle>
                        <text x="100" y="155" font-family="monospace" font-size="20" fill="black" text-anchor="middle">"Geld"</text>
                        <path d="M 140 150 C 220 150, 280 80, 350 70" stroke="rgb(156, 163, 175)" stroke-width="2" fill="none" marker-end="url(#arrow)"></path>
                        <text x="240" y="130" font-family="sans-serif" font-size="16" fill="rgb(113,113,122)">beeinflusst</text>

                        <!-- Kontext: Park -->
                        <circle cx="100" cy="250" r="40" fill="rgb(134, 239, 172)"></circle>
                        <text x="100" y="255" font-family="monospace" font-size="20" fill="black" text-anchor="middle">"Park"</text>
                        <path d="M 140 250 C 220 250, 280 200, 350 80" stroke="rgb(156, 163, 175)" stroke-width="2" fill="none" marker-end="url(#arrow)"></path>
                         <text x="240" y="230" font-family="sans-serif" font-size="16" fill="rgb(113,113,122)">beeinflusst</text>

                        <!-- Ergebnis 1: Finanzinstitut -->
                        <rect x="550" y="125" width="230" height="50" rx="10" fill="rgb(252, 211, 77)" fill-opacity="0.8"></rect>
                        <text x="665" y="160" font-family="monospace" font-size="18" fill="black" text-anchor="middle">Kontext: Finanzinstitut</text>

                         <!-- Ergebnis 2: Parkbank -->
                        <rect x="550" y="225" width="230" height="50" rx="10" fill="rgb(134, 239, 172)" fill-opacity="0.8"></rect>
                        <text x="665" y="260" font-family="monospace" font-size="18" fill="black" text-anchor="middle">Kontext: Parkbank</text>

                        <path d="M 450 70 C 500 100, 520 130, 550 145" stroke="rgb(156, 163, 175)" stroke-width="2" fill="none" marker-end="url(#arrow)"></path>
                        <path d="M 450 70 C 500 180, 520 230, 550 245" stroke="rgb(156, 163, 175)" stroke-width="2" fill="none" marker-end="url(#arrow)"></path>
                    </svg>
                </div>
            </div>

            <div class="border-t pt-8">
                <h2 class="text-2xl font-bold mb-4">Query und Key Vektoren</h2>
                <p>Innerhalb der Attention wird mit jedem Token zwei Matrixmultiplikationen durchgeführt. Beide Matrizen bestehen komplett aus Modelparameter, welche, während dem Lernen der LLM definiert werden. Als Ergebnis der beiden Multiplikationen erhalten wir Query und Key Vektoren, diese befinden sich in einer kleineren Dimension im Vergleich zum ursprünglichen Einbettungsraum.</p>
                <p class="mt-4">Die erste Matrixmultiplikation ergibt einen Query-Vektor, welcher eine Frage an die umliegenden Tokens widerspiegelt. Ein sehr stark vereinfachtes Beispiel ist, dass die Matrik, welche bei der Matrixmultiplikation für den Query-Vektor verwendet wird, bei Nomen den Fragenvektor “Gibt es Adjektive vor mir?” zurückgibt.</p>
                <p class="mt-4">Bei der zweiten Matrixmultiplikation erhalten wir einen Key-Vektor. Der Key-Vektor ist die Antwort zu der Frage des Query-Vektors. Hier würden in unserem Beispiel die Adjektive die Antwort geben “Ich bin ein Adjektiv an der Position X”.</p>
                <div class="mt-6 bg-gray-100 p-6 rounded-lg">
                    <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg" class="w-full">
                        <style>
                            .flow-text { font-family: monospace; font-size: 16px; }
                            .matrix { fill: rgb(224, 231, 255); stroke: rgb(99, 102, 241); stroke-width: 1; }
                            .vector { fill: rgb(219, 234, 254); stroke: rgb(59, 130, 246); stroke-width: 1; }
                            .output-vector { fill: rgb(254, 226, 226); stroke: rgb(239, 68, 68); stroke-width: 1; }
                            .path-line { stroke: rgb(156, 163, 175); stroke-width: 2; fill: none; marker-end: url(#arrow); }

                            .token-flow { animation: token-flow-anim 8s infinite; }
                            @keyframes token-flow-anim {
                                0%, 20% { transform: translateX(0); opacity: 1; }
                                30%, 100% { transform: translateX(200px); opacity: 1; }
                            }
                            .query-vec-gen { animation: query-vec-gen-anim 8s infinite; }
                            @keyframes query-vec-gen-anim {
                                0%, 30% { opacity: 0; transform: scale(0.5); }
                                40%, 100% { opacity: 1; transform: scale(1); }
                            }
                            .key-vec-gen { animation: key-vec-gen-anim 8s infinite; }
                             @keyframes key-vec-gen-anim {
                                0%, 50% { opacity: 0; transform: scale(0.5); }
                                60%, 100% { opacity: 1; transform: scale(1); }
                            }
                        </style>
                        <defs>
                             <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgb(156, 163, 175)"></path>
                            </marker>
                        </defs>

                        <!-- Labels -->
                        <text x="50" y="30" class="flow-text font-semibold">Input Token Vektor</text>
                        <text x="300" y="30" class="flow-text font-semibold">Gewichtsmatrizen</text>
                        <text x="600" y="30" class="flow-text font-semibold">Output Vektoren</text>

                        <!-- Input Token -->
                        <g class="token-flow">
                            <rect x="20" y="180" width="100" height="40" rx="5" class="vector"></rect>
                            <text x="70" y="205" text-anchor="middle" class="flow-text">Token x</text>
                        </g>

                        <!-- Query Path -->
                        <rect x="280" y="80" width="150" height="60" rx="5" class="matrix"></rect>
                        <text x="355" y="115" text-anchor="middle" class="flow-text">Query Matrix (WQ)</text>
                        <path d="M 225 200 C 250 200, 270 120, 280 120" class="path-line" />
                        <g class="query-vec-gen">
                            <path d="M 430 110 L 580 110" class="path-line" />
                            <rect x="580" y="90" width="120" height="40" rx="5" class="output-vector"></rect>
                            <text x="640" y="115" text-anchor="middle" class="flow-text">Query (q)</text>
                        </g>

                        <!-- Key Path -->
                        <rect x="280" y="260" width="150" height="60" rx="5" class="matrix"></rect>
                        <text x="355" y="295" text-anchor="middle" class="flow-text">Key Matrix (WK)</text>
                         <path d="M 225 200 C 250 200, 270 280, 280 280" class="path-line" />
                         <g class="key-vec-gen">
                            <path d="M 430 290 L 580 290" class="path-line" />
                            <rect x="580" y="270" width="120" height="40" rx="5" class="output-vector"></rect>
                            <text x="640" y="295" text-anchor="middle" class="flow-text">Key (k)</text>
                        </g>
                    </svg>
                </div>
            </div>

            <div class="border-t pt-8">
                <h2 class="text-2xl font-bold mb-4">Skalarprodukt vom Key und Query Vektor</h2>
                <p>Sobald für jeden Token ein Key und Query-Vektor berechnet wurde, wird das Skalarprodukt von jedem Key-Vektor mit jedem Query-Vektor ausgerechnet. Wenn das Skalarprodukt von einem Query-Vektor und einem Key-Vektor stark positiv ist, bedeutet dies, dass das Token vom Key-Vektor auf das Token vom Query-Vektor Einfluss haben sollte. Bei Skalaren nahe bei Eins oder im Minus beeinflussen die Token sich nicht oder nur sehr schwach gegenseitig. Bei unserem Beispiel würde das Skalarprodukt von einem Adjektiv Key-Vektor und einem Nomen Query-Token ein sehr hohes Skalarprodukt ergeben und somit aufzeigen, dass ein Adjektiv ein Nomen stark beeinflusst.</p>
                <div class="mt-6 bg-gray-100 p-6 rounded-lg overflow-x-auto">
                    <p class="text-center font-semibold mb-4">Beispielsatz: "Das braune Brot"</p>
                    <div class="flex justify-center">
                        <div class="grid grid-cols-4 gap-1 text-sm text-center">
                            <div class="p-2 font-bold"></div>
                            <div class="p-2 font-bold">Key: "Das"</div>
                            <div class="p-2 font-bold">Key: "braune"</div>
                            <div class="p-2 font-bold">Key: "Brot"</div>

                            <!-- Query: "Das" -->
                            <div class="p-2 font-bold self-center">Query: "Das"</div>
                            <div class="p-4 bg-blue-200 rounded">3.2</div>
                            <div class="p-4 bg-blue-100 rounded">1.1</div>
                            <div class="p-4 bg-blue-100 rounded">0.5</div>

                            <!-- Query: "braune" -->
                            <div class="p-2 font-bold self-center">Query: "braune"</div>
                            <div class="p-4 bg-blue-100 rounded">1.5</div>
                            <div class="p-4 bg-blue-200 rounded">4.8</div>
                            <div class="p-4 bg-red-300 rounded font-bold">12.1</div>

                            <!-- Query: "Brot" -->
                            <div class="p-2 font-bold self-center">Query: "Brot"</div>
                            <div class="p-4 bg-blue-100 rounded">2.1</div>
                            <div class="p-4 bg-red-300 rounded font-bold">15.3</div>
                            <div class="p-4 bg-blue-200 rounded">5.5</div>
                        </div>
                    </div>
                    <p class="text-center text-sm mt-4 text-gray-600">Die Skalarprodukte zwischen den Query- und Key-Vektoren. Ein hoher Wert (rot) zwischen dem Query für "Brot" und dem Key für "braune" signalisiert eine starke Beziehung.</p>
                </div>
            </div>

            <div class="border-t pt-8">
                <h2 class="text-2xl font-bold mb-4">Softmax</h2>
                <p>Sämtliche Skalarprodukte von Key-Vektoren, welche nach einem Query-Vektor in der Reihenfolge sind, werden auf minus Unendlich gesetzt. Dies bewirkt, dass in folgendem Beispielsatz: “Das braune Brot auf dem schwarzen Tisch” das Token für “schwarzen” das Token für “Brot” nicht beeinflusst.</p>
                <p class="mt-4">Anschliessend wir ein Softmax von allen Skalaren von einem Query-Vektor und allen Key-Vektoren genommen. Softmax setzt alle Werte im Minus Bereich auf Null und gewichtet alle positiven Zahle so, dass am Schluss die Summe sämtlicher Zaheln zusammenaddiert Eins ergeben. Das Ergebnis vom Softmax ist eine normalisierte Spalte, in welcher abgelesen werden kann welcher Token welchen Token wie fest beeinflussen muss.</p>
                <div class="mt-6 bg-gray-100 p-6 rounded-lg overflow-x-auto">
                    <p class="text-center font-semibold mb-4">Attention-Gewichte nach Softmax</p>
                    <div class="flex justify-center">
                        <div class="grid grid-cols-4 gap-1 text-sm text-center">
                            <div class="p-2 font-bold"></div>
                            <div class="p-2 font-bold">Key: "Das"</div>
                            <div class="p-2 font-bold">Key: "braune"</div>
                            <div class="p-2 font-bold">Key: "Brot"</div>

                            <!-- Query: "Das" -->
                            <div class="p-2 font-bold self-center">Query: "Das"</div>
                            <div class="p-4 bg-green-400 rounded font-bold">0.89</div>
                            <div class="p-4 bg-green-200 rounded">0.10</div>
                            <div class="p-4 bg-green-100 rounded">0.01</div>

                            <!-- Query: "braune" -->
                            <div class="p-2 font-bold self-center">Query: "braune"</div>
                            <div class="p-4 bg-gray-400 rounded text-white">-inf</div>
                            <div class="p-4 bg-green-200 rounded">0.15</div>
                            <div class="p-4 bg-green-400 rounded font-bold">0.85</div>
                            
                            <!-- Query: "Brot" -->
                            <div class="p-2 font-bold self-center">Query: "Brot"</div>
                             <div class="p-4 bg-gray-400 rounded text-white">-inf</div>
                            <div class="p-4 bg-gray-400 rounded text-white">-inf</div>
                            <div class="p-4 bg-green-500 rounded font-bold">1.00</div>
                        </div>
                    </div>
                    <p class="text-center text-sm mt-4 text-gray-600">Nach Softmax werden die Werte zu Wahrscheinlichkeiten normalisiert. Werte, die in der Zukunft liegen, werden maskiert (-inf). Man sieht, dass "Brot" zu 85% von "braune" beeinflusst wird.</p>
                </div>
            </div>

            <div class="border-t pt-8">
                <h2 class="text-2xl font-bold mb-4">Beeinflussung</h2>
                <p>Nun wissen wir, zum Beispiel, dass “braun” die Einbettung für “Brot” beeinflussen muss. Für die eigentlich Beeinflussung muss nun die Einbettung vom "Brot” Token angepasst werden. Hier wird eine weitere Matrixmultiplikation gerechnet. Auch bei dieser besteht die Matrik aus Modelparameter, die wiederum, während dem Lernen gesetzt werden. Die Einbettung von jedem Token wird mit der Matrik multipliziert, draus erhält man einen weiteren Vektor, der aufzeigt, was bei einem anderen Token addiert werden muss, um diesen zu beeinflussen. Diesen Vektor nennen wir von nun an “Value-Vektor”. Bei unserem Beispiel würde die Multiplikation, der Matrik, mit dem Vektor für “braun” ein Value-Vektor ergeben, welcher zu “Brot” addiert werden kann. Das Ergebnis daraus wäre “Brot” mit dem Kontext “braun”.</p>
                <p class="mt-4">Da wir mehrere Tokens haben, welche unterschiedlich stark einen Token beeinflussen, müssen sämtliche Value-Vektoren mit dem Softmax Ergebnis des gleichen Key-Token multipliziert werden. Anschliessend werden alle Ergebnisse für ein Query-Token zusammenaddiert, um einen Vektor zu erhalten, welcher die unterschiedlichen Beeinflussungen beinhaltet. In unserem Beispiel könnte also mit einem Vektor zum Token “Brot” “braun, hell, frisch” als Kontext dazu addiert werden, wobei die einzelnen Kontextwörter unterschiedlich gewichtet wurden.</p>
                <p class="mt-4">Nun konnten wir erfolgreich Kontext, aufgrund anderen Tokens, zu einem zuvor Kontextlosen Token hinzufügen.</p>
                 <div class="mt-6 bg-gray-100 p-6 rounded-lg">
                    <svg viewBox="0 0 850 400" xmlns="http://www.w3.org/2000/svg" class="w-full">
                    <style>
                      .label{font-family:sans-serif;font-size:16px;text-anchor:middle}.op-label,.token-label{font-family:monospace;text-anchor:middle}.token-label{font-size:14px}.op-label{font-size:24px}.value-vec{fill:#dcfce7;stroke:#22c55e;stroke-width:1}.attn-score,.weighted-vec{fill:#fef9c3;stroke:#f59e0b;stroke-width:1}.weighted-vec{fill:#fee2e2;stroke:#ef4444}.path-line{stroke:#9ca3af;stroke-width:2;fill:none;marker-end:url(#arrow)}
                    </style>
                    <defs>
                      <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="5" markerHeight="6" orient="auto-start-reverse">
                       <path d="m0 0 10 5-10 5z" fill="#9ca3af"/>
                      </marker>
                    </defs>
                    <text x="425" y="30" class="label font-bold">Berechnung des neuen Token-Vektors</text>
                    <text x="100" y="80" class="label">Value Vektoren (v)</text>
                    <text x="250" y="80" class="label">Attn Scores (a)</text>
                    <text x="450" y="80" class="label">Gewichtete Vektoren</text>
                    <text x="590" y="150" class="label">Token Vektor (e)</text>
                    <rect x="50" y="100" width="100" height="40" rx="5" class="value-vec"/>
                    <text x="100" y="125" class="token-label">v(&quot;Das&quot;)</text>
                    <text x="175" y="125" class="op-label">x</text>
                    <rect x="200" y="100" width="100" height="40" rx="5" class="attn-score"/>
                    <text x="250" y="125" class="token-label">a = 0.05</text>
                    <path d="M300 120h95" class="path-line"/>
                    <rect x="400" y="100" width="100" height="40" rx="5" class="weighted-vec"/>
                    <text x="450" y="125" class="token-label">vg(&quot;Das&quot;)</text>
                   <rect x="50" y="180" width="100" height="40" rx="5" class="value-vec"/>
                    <text x="100" y="205" class="token-label">v(&quot;braune&quot;)</text>
                    <text x="175" y="205" class="op-label">x</text>
                    <rect x="200" y="180" width="100" height="40" rx="5" class="attn-score"/>
                    <text x="250" y="205" class="token-label">a = 0.85</text>
                    <path d="M300 200h95" class="path-line"/>
                    <rect x="400" y="180" width="100" height="40" rx="5" class="weighted-vec"/>
                    <text x="450" y="205" class="token-label">vg(&quot;braune&quot;)</text>
                    <rect x="50" y="260" width="100" height="40" rx="5" class="value-vec"/>
                    <text x="100" y="285" class="token-label">v(&quot;Brot&quot;)</text>
                    <text x="175" y="285" class="op-label">x</text>
                    <rect x="200" y="260" width="100" height="40" rx="5" class="attn-score"/>
                    <text x="250" y="285" class="token-label">a = 0.10</text>
                    <path d="M300 280h95" class="path-line"/>
                    <rect x="400" y="260" width="100" height="40" rx="5" class="weighted-vec"/>
                    <text x="450" y="285" class="token-label">vg(&quot;Brot&quot;)</text>
                    <text x="450" y="246" class="op-label" fill="#6b7280">+</text>
                    <text x="450" y="166" class="op-label" fill="#6b7280">+</text>
                   <text x="525" y="210" class="op-label" fill="#6b7280">+</text>
                   <rect x="550" y="180" width="80" height="40" rx="5" style="fill:#e9d5ff;stroke:#a855f7;stroke-width:2"/>
                    <text x="590" y="205" class="token-label">e(Brot)</text>
                    <path d="M630 200h65" class="path-line"/>
                    <rect x="700" y="180" width="110" height="40" rx="5" style="fill:#e9d5ff;stroke:#a855f7;stroke-width:2"/>
                    <text x="755" y="195" class="token-label">Neuer Vektor</text>
                    <text x="755" y="215" class="token-label">mit Kontext</text>
                  </svg>
                 </div>
            </div>

            <div class="border-t pt-8">
                <h2 class="text-2xl font-bold mb-4">Multi-Headed Attention</h2>
                <p>Sämtliche Schritte, welche nun erklärt wurden, werden in der Fachsprache einen “Head” genannt. In fast allen LLM’s gibt es nicht nur einen “Head” in der Attention, sondern viele aneinander gereihte “Head”. Dies wird dann Multi-Headed Attention genannt. Der Hauptgrund, wieso eine Multi-Headed Attention durchgeführt wird, ist, dass bei jedem einzelnen “Head” neue Matriken verwendet werden, welche aus unterschiedlichen Modellparamter bestehen. Somit kann Kontext noch schneller und genauer bei Tokens hinzugefügt werden.</p>
                <div class="mt-6 bg-gray-100 p-6 rounded-lg">
                    <svg viewBox="0 0 900 250" xmlns="http://www.w3.org/2000/svg" class="w-full">
                        <defs>
                            <marker id="arrow-h" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgb(156, 163, 175)"></path>
                            </marker>
                        </defs>
                        <style>
                            .label { font-family: sans-serif; font-size: 16px; text-anchor: middle; }
                            .head-label { font-family: monospace; font-size: 14px; text-anchor: middle; }
                            .head-box { fill: rgb(220, 252, 231); stroke: rgb(34, 197, 94); }
                            .path-line-h { stroke: rgb(156, 163, 175); stroke-width: 2; fill: none; marker-end: url(#arrow-h); }
                        </style>

                        <text x="450" y="30" class="label font-bold">Multi-Headed Attention</text>

                        <!-- Input -->
                        <text x="100" y="125" class="label">Input</text>
                        <path d="M 125 120 H 240" class="path-line-h" />

                        <!-- Heads -->
                        <g>
                            <rect x="240" y="90" width="100" height="60" rx="5" class="head-box" />
                            <text x="290" y="125" class="head-label">Head 1</text>
                        </g>
                        <path d="M 340 120 H 400" class="path-line-h" />

                        <g>
                            <rect x="400" y="90" width="100" height="60" rx="5" class="head-box" />
                            <text x="450" y="125" class="head-label">Head 2</text>
                        </g>
                        <path d="M 500 120 H 560" class="path-line-h" />

                        <g>
                            <rect x="560" y="90" width="100" height="60" rx="5" class="head-box" />
                            <text x="610" y="125" class="head-label">Head n</text>
                        </g>

                        <!-- Concatenate & Final Output -->
                        <path d="M 660 120 H 730" class="path-line-h" />
                        <text x="760" y="125" class="label">Output</text>

                    </svg>
                </div>
            </div>
        </div>
    </main>
</body>
</html>
